================================================================================
ECHOBOT EMAIL TROUBLESHOOTING LOG
================================================================================
Last Updated: December 29, 2025
Status: BLOCKED - Gmail SMTP access temporarily blocked by Google

================================================================================
ISSUE SUMMARY
================================================================================

Email digest sending fails despite correct configuration. Digests generate 
successfully but SMTP authentication to Gmail is blocked by Google's security.

Error Message:
  535 5.7.8 Username and Password not accepted. For more information, go to
  5.7.8 https://support.google.com/mail/?p=BadCredentials

Root Cause: Multiple failed login attempts from different IPs (GitHub Codespace 
+ Azure container) triggered Google's security block.

================================================================================
WHAT'S WORKING ✅
================================================================================

1. Azure environment variables properly injected into container
   - Verified via SSH: env | grep -E "SMTP|EMAIL|ENABLE" shows all values
   
2. ENABLE_EMAIL=true is correctly set

3. Digest generation works perfectly
   - Dec 25, 26 digests generated successfully
   
4. Code fixes deployed:
   - make_anchor() function added to email_service.py
   - db.create_daily_digest() call fixed in summarization.py
   
5. API endpoint exists and responds:
   - POST /api/send-digest-email?date=YYYY-MM-DD

================================================================================
WHAT'S NOT WORKING ❌
================================================================================

1. Gmail SMTP authentication fails
2. Google has blocked SMTP access from our IPs

================================================================================
CURRENT CREDENTIALS & CONFIGURATION
================================================================================

SMTP_HOST     = smtp.gmail.com
SMTP_PORT     = 587
SMTP_USER     = barbados.radio.synopsis@gmail.com
SMTP_PASS     = izqmqvguzimszszin (current - may need regeneration)
EMAIL_FROM    = barbados.radio.synopsis@gmail.com
EMAIL_TO      = delano@futurebarbados.bb,anya@futurebarbados.bb,Roy.morris@barbados.gov.bb,delanowaithe@gmail.com
ENABLE_EMAIL  = true

Previous password that worked (Dec 25): tmwghumbxntlikgq

================================================================================
AZURE RESOURCES
================================================================================

App Service:    echobot-docker-app
Resource Group: echobot-rg
SSH Command:    az webapp ssh --name echobot-docker-app --resource-group echobot-rg

================================================================================
TROUBLESHOOTING STEPS ALREADY TRIED
================================================================================

[✅] Verified Azure app settings are correct
[✅] Restarted app to reload environment variables
[✅] Confirmed env vars load in container via SSH
[❌] Generated new Gmail app password - didn't work
[❌] Tried original password - blocked by Google
[❌] User verified "unfamiliar activity" prompt in Gmail - still blocked
[❌] Tried https://accounts.google.com/DisplayUnlockCaptcha - still blocked

================================================================================
NEXT STEPS TO TRY
================================================================================

STEP 1: Test if Google block has lifted
-----------------------------------------
Run this in terminal (no SSH needed):

python3 -c "
import smtplib
server = smtplib.SMTP('smtp.gmail.com', 587)
server.starttls()
server.login('barbados.radio.synopsis@gmail.com', 'tmwghumbxntlikgq')
print('SUCCESS!')
server.quit()
"

STEP 2: If old password works, update Azure
--------------------------------------------
az webapp config appsettings set \
  --name echobot-docker-app \
  --resource-group echobot-rg \
  --settings SMTP_PASS="tmwghumbxntlikgq"

az webapp restart --name echobot-docker-app --resource-group echobot-rg

STEP 3: If still blocked, generate NEW app password
----------------------------------------------------
1. Go to https://myaccount.google.com/apppasswords
2. Log in as barbados.radio.synopsis@gmail.com
3. DELETE all existing app passwords
4. Create a new app password
5. Copy the 16-character password (remove spaces)
6. Update Azure immediately:

az webapp config appsettings set \
  --name echobot-docker-app \
  --resource-group echobot-rg \
  --settings SMTP_PASS="your-new-16-char-password"

az webapp restart --name echobot-docker-app --resource-group echobot-rg

STEP 4: Test via API
---------------------
curl -X POST "https://echobot-docker-app.azurewebsites.net/api/send-digest-email" -d "date=2025-12-26"

STEP 5: Alternative - SSH and send directly
--------------------------------------------
If API still fails, SSH in and run Python directly:

az webapp ssh --name echobot-docker-app --resource-group echobot-rg

# Then in SSH:
export SMTP_PASS="your-password"
cd /app
python3 -c "
from email_service import email_service
from datetime import date
result = email_service.send_program_digests(date(2025, 12, 26))
print(result)
"

================================================================================
FILES MODIFIED DURING TROUBLESHOOTING
================================================================================

email_service.py
  - Added make_anchor() function for HTML anchor generation

summarization.py
  - Fixed db.create_daily_digest() call (removed extra argument)

simple_digest_generator.py
  - Added --date argument parsing

README.md
  - Added Email Troubleshooting section

.gitignore
  - Added diagnostic scripts to prevent credential commits

================================================================================
ALTERNATIVE EMAIL SOLUTIONS (IF GMAIL CONTINUES TO FAIL)
================================================================================

Option 1: SendGrid (Free 100 emails/day)
-----------------------------------------
1. Sign up at https://sendgrid.com
2. Create an API key
3. Update Azure settings:
   SMTP_HOST=smtp.sendgrid.net
   SMTP_PORT=587
   SMTP_USER=apikey
   SMTP_PASS=your-sendgrid-api-key

Option 2: Amazon SES
--------------------
Similar setup, requires AWS account and domain verification.

Option 3: Different Gmail Account
----------------------------------
Create new Gmail, enable 2FA, generate app password, use fresh credentials.

================================================================================
TIMELINE OF EVENTS
================================================================================

Dec 25, 2025 - Email sending worked successfully with password: tmwghumbxntlikgq
Dec 26, 2025 - Email API reported "email service may be disabled"
Dec 26, 2025 - Discovered Azure env vars not loading in container
Dec 26, 2025 - Fixed code issues (make_anchor, db call)
Dec 26, 2025 - Deployed fixes via git
Dec 26, 2025 - Generated new app password: izqmqvguzimszszin
Dec 26, 2025 - Multiple failed login attempts triggered Google block
Dec 27, 2025 - Verified env vars now load correctly after restart
Dec 27, 2025 - User verified "unfamiliar activity" in Gmail
Dec 27, 2025 - SMTP still blocked
Dec 29, 2025 - SMTP still blocked - waiting for Google to lift block

================================================================================
CONTACT FOR ISSUES
================================================================================

Email Recipients:
- delano@futurebarbados.bb
- anya@futurebarbados.bb
- Roy.morris@barbados.gov.bb
- delanowaithe@gmail.com

Gmail Account Owner: barbados.radio.synopsis@gmail.com

================================================================================
END OF TROUBLESHOOTING LOG
================================================================================
