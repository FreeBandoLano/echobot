{% set filler_threshold_warn = 35 %}
{% set filler_threshold_high = 55 %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Segment Timeline ({{ days }} day{{ '' if days==1 else 's' }})</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { font-size: 14px; }
    .seg-row { border-bottom: 1px solid #eee; padding: 4px 0; }
    .seg-guard { background: #ffe9e9; }
    .seg-meta { font-size: 11px; color: #666; }
    .sticky-head { position: sticky; top:0; background:#fff; z-index:10; padding:6px 0; }
    .pill { padding:2px 8px; border-radius:12px; font-size:12px; }
    .pill-ok { background:#e6f6ed; color:#136f3d; }
    .pill-warn { background:#fff4d6; color:#8a5b00; }
    .pill-high { background:#fde2e1; color:#912c24; }
    .mono { font-family: monospace; }
    .truncate { max-width: 620px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .highlight-pulse { animation: pulseHighlight 3.5s ease-out forwards; }
  @keyframes pulseHighlight { 0% { background:#fff3b0; box-shadow:0 0 0 0 rgba(255,193,7,0.6); } 40% { background:#ffe37a; box-shadow:0 0 0 6px rgba(255,193,7,0); } 100% { background:transparent; } }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-3">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">Dashboard</a>
    <div class="navbar-nav">
      <a class="nav-link active" href="/timeline">Timeline</a>
      <a class="nav-link" href="/analytics">Analytics</a>
    </div>
  </div>
</nav>
<div class="container-fluid">
  <div class="d-flex align-items-center justify-content-between mb-2">
    <h5 class="mb-0">Continuous Segment Timeline (last {{ days }} day{{ '' if days==1 else 's' }})</h5>
    <form method="get" class="d-flex align-items-center gap-1">
      <label class="me-1 small">Range:</label>
      <select name="days" class="form-select form-select-sm" onchange="this.form.submit()">
        {% for d in [1,2,3,5,7] %}
          <option value="{{ d }}" {% if d==days %}selected{% endif %}>{{ d }}</option>
        {% endfor %}
      </select>
    </form>
  </div>
  <div class="mb-3">
    {% set pill_class = 'pill-ok' %}
    {% if stats.filler_pct >= filler_threshold_high %}{% set pill_class = 'pill-high' %}
    {% elif stats.filler_pct >= filler_threshold_warn %}{% set pill_class = 'pill-warn' %}{% endif %}
    <span class="pill {{ pill_class }}">Filler {{ stats.filler_pct }}% ({{ stats.filler_seconds }}s / {{ stats.total_seconds }}s)</span>
    <small class="text-muted ms-2">{{ stats.total_segments }} segments</small>
  </div>
  <div class="row fw-bold border-bottom sticky-head">
    <div class="col-2">Date / Block</div>
    <div class="col-1">Start</div>
    <div class="col-1">Dur (s)</div>
    <div class="col-2">Speaker</div>
    <div class="col-6">Text</div>
  </div>
  {% set last_block = None %}
  {% for s in segments %}
    {% set duration = (s.end_sec - s.start_sec) if s.end_sec and s.start_sec is not none else 0 %}
    {% if last_block != s.block_id %}
      <!-- Anchor placeholder for block-level hash (#block-{block_id}) -->
      <div id="block-{{ s.block_id }}" style="position:relative; top:-60px;"></div>
    {% endif %}
    <div class="row seg-row {% if s.guard_band %}seg-guard{% endif %}" id="block-{{ s.block_id }}-seg-{{ loop.index }}" data-block="{{ s.block_id }}">
      <div class="col-2 mono">{{ s.show_date }} / {{ s.block_code }} <a href="/block/{{ s.block_id }}" class="text-decoration-none ms-1">↗</a></div>
      <div class="col-1 mono">{{ '%.1f'|format(s.start_sec) }}</div>
      <div class="col-1 mono">{{ '%.1f'|format(duration) }}</div>
      <div class="col-2">{{ s.speaker or '—' }} {% if s.guard_band %}<span class="badge bg-danger ms-1">Filler</span>{% endif %}</div>
      <div class="col-6 truncate" title="{{ s.text }}">{{ s.text }}</div>
    </div>
    {% set last_block = s.block_id %}
  {% endfor %}
  {% if not segments %}
    <div class="alert alert-info mt-3">No segments available yet. Backfill may still be running.</div>
  {% endif %}
</div>
<script>
// Auto-scroll & highlight target block anchor
(function(){
  function activateAnchor(){
    var hash = window.location.hash;
    if(!hash || hash.length < 2) return;
    var id = hash.substring(1);
    var anchor = document.getElementById(id);
    if(!anchor){
      // fallback: find first segment row for block
      var seg = document.querySelector('[id^="'+id+'-seg-"]');
      if(seg) anchor = seg;
    }
    if(anchor){
      // If placeholder div, find next segment row sibling for highlight
      var targetRow = anchor.classList.contains('seg-row') ? anchor : anchor.nextElementSibling;
      if(targetRow){
        targetRow.classList.add('highlight-pulse');
        // Center in viewport
        setTimeout(function(){ targetRow.scrollIntoView({behavior:'smooth', block:'center'}); }, 50);
        // Clean up class after animation (~3.5s)
        setTimeout(function(){ targetRow.classList.remove('highlight-pulse'); }, 3800);
      }
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', activateAnchor);
  } else {
    activateAnchor();
  }
})();
</script>
</body>
</html>
