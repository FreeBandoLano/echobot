
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Government Radio Synopsis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/theme.css">
    <style>
        /* Minimal override helpers (panel print + utility spacing if needed) */
        @media print { .hub-wrapper, .orbit-btn { display: none !important; } }
    </style>
</head>
<body data-is-today="{{ 1 if is_today else 0 }}" data-view-date="{{ view_date.strftime('%Y-%m-%d') }}">
    <header class="app-header">
        <a href="/" class="app-logo"><i class="bi bi-broadcast"></i> <span>Radio Synopsis</span></a>
        <div class="app-date">
            <i class="bi bi-calendar3"></i> {{ view_date.strftime('%B %d, %Y') }}
            {% if is_today %}<span class="app-live">‚óè LIVE</span>{% endif %}
        </div>
    </header>
    <main>
    <div class="hub-stage" id="hub-stage">
    <div class="hub-wrapper">
            <div class="hub-core" id="hub" data-state="idle" tabindex="0" aria-haspopup="true" aria-expanded="false">
                <i class="bi bi-grid-3x3-gap hub-icon"></i>
                <div class="hub-label">Control Hub</div>
                <div class="hub-ring" aria-hidden="true"></div>
            </div>
            <svg class="hub-links" viewBox="0 0 340 340" preserveAspectRatio="xMidYMid meet" aria-hidden="true"></svg>
            <!-- Orbit buttons (positioned via JS) -->
            <button class="orbit-btn" data-panel="overview" aria-label="Overview">
                <i class="bi bi-graph-up orbit-icon"></i><span>Overview</span>
            </button>
            <button class="orbit-btn" data-panel="blocks" aria-label="Blocks">
                <i class="bi bi-list-ul orbit-icon"></i><span>Blocks</span>
            </button>
            <button class="orbit-btn" data-panel="digest" aria-label="Digest">
                <i class="bi bi-file-text orbit-icon"></i><span>Digest</span>
            </button>
            <button class="orbit-btn" data-panel="archive" aria-label="Archive">
                <i class="bi bi-archive orbit-icon"></i><span>Archive</span>
            </button>
    </div>
    </div>

        <!-- Panels -->
        <section class="panel" id="panel-overview" aria-labelledby="heading-overview" data-active="false">
            <h2 id="heading-overview"><i class="bi bi-graph-up"></i> Today's Overview</h2>
            <div class="status-grid">
                <div class="status-card">
                    <div class="status-icon"><i class="bi bi-check-circle"></i></div>
                    <div class="status-value">{{ stats.completed_blocks }}</div>
                    <div class="status-label">Completed</div>
                </div>
                <div class="status-card">
                    <div class="status-icon"><i class="bi bi-collection"></i></div>
                    <div class="status-value">{{ stats.total_blocks }}</div>
                    <div class="status-label">Total Blocks</div>
                </div>
                <div class="status-card">
                    <div class="status-icon"><i class="bi bi-people"></i></div>
                    <div class="status-value">{{ stats.total_callers }}</div>
                    <div class="status-label">Callers</div>
                </div>
                <div class="status-card">
                    <div class="status-icon"><i class="bi bi-percent"></i></div>
                    <div class="status-value">{{ stats.completion_rate }}%</div>
                    <div class="status-label">Progress</div>
                </div>
            </div>
        </section>

        <section class="panel" id="panel-blocks" aria-labelledby="heading-blocks" data-active="false">
            <h2 id="heading-blocks"><i class="bi bi-list-ul"></i> Program Blocks</h2>
            {% if is_today %}
            <div style="margin:.75rem 0 1.25rem; padding:.75rem 1rem; background:var(--color-panel-alt); border:1px solid var(--color-border); border-radius:var(--radius-md);">
                <div style="display:flex; flex-wrap:wrap; gap:.85rem; align-items:flex-end;">
                    <div style="flex:1 1 100%; font-size:.6rem; letter-spacing:.12em; color:var(--text-tertiary); font-weight:600;">TEST RECORDING (Temporary)</div>
                    {% for code in ['A','B','C','D'] %}
                    <form method="post" action="/api/manual-record-duration" style="display:flex; flex-direction:column; gap:.35rem; background:var(--color-overlay); padding:.6rem .7rem .7rem; border:1px solid var(--color-border); border-radius:var(--radius-sm); min-width:140px;">
                        <input type="hidden" name="block_code" value="{{ code }}">
                        <div style="font-size:.65rem; font-weight:600; letter-spacing:.08em;">Block {{ code }}</div>
                        <label style="font-size:.55rem; letter-spacing:.08em; opacity:.75;">Duration</label>
                        <select name="duration_minutes" style="font-size:.65rem; padding:.15rem .25rem; border:1px solid var(--color-border); background:var(--color-panel-alt); border-radius: var(--radius-sm);">
                            <option value="1" selected>1 min</option>
                            <option value="2">2 min</option>
                            <option value="5">5 min</option>
                        </select>
                        <button type="submit" style="margin-top:.2rem; font-size:.55rem; letter-spacing:.12em; font-weight:600; padding:.4rem .5rem; border:none; border-radius:var(--radius-pill); background:var(--grad-active); color:var(--text-inverse); cursor:pointer;">START</button>
                    </form>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            {% for block in blocks %}
            <div class="block-summary">
                <div class="block-header">
                    <div class="block-title">Block {{ block.block_code }} - {{ block.block_name }}</div>
                    <div class="block-status" data-state="{{ 'completed' if block.status == 'completed' else 'processing' if block.status in ['recording','transcribing','summarizing'] else 'pending' }}">
                        {% if block.status == 'completed' %}
                            <i class="bi bi-check-circle"></i>
                        {% elif block.status in ['recording','transcribing','summarizing'] %}
                            <i class="bi bi-arrow-clockwise"></i>
                        {% else %}
                            <i class="bi bi-clock"></i>
                        {% endif %}
                        {{ block.status.title() if block.status != 'completed' else 'Complete' }}
                    </div>
                </div>
                {% if block.summary %}
                    <p class="block-body">{{ block.summary.summary_text[:150] }}{% if block.summary.summary_text|length > 150 %}...{% endif %}</p>
                    {% if block.emergent_themes %}
                        <div style="margin:.5rem 0; display:flex; gap:.4rem; flex-wrap:wrap;">
                            {% for theme in block.emergent_themes %}
                                <span style="background:var(--color-overlay); border:1px solid var(--color-border); padding:.25rem .5rem; border-radius:var(--radius-pill); font-size:.6rem; letter-spacing:.08em; color:var(--text-tertiary);">{{ theme }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                    <div class="block-footer">
                        <span><i class="bi bi-people"></i> {{ block.summary.caller_count }} callers</span>
                        <button class="block-action" data-block-id="{{ block.id }}">DETAILS</button>
                    </div>
                {% else %}
                    <p class="block-body">
                        {% if block.status == 'pending' %}
                            <i class="bi bi-clock"></i> Scheduled for {{ block.start_time }}
                        {% else %}
                            <i class="bi bi-hourglass-split"></i> Processing...
                        {% endif %}
                    </p>
                {% endif %}
            </div>
            {% endfor %}
        </section>

        {% if digest %}
        <section class="panel" id="panel-digest" aria-labelledby="heading-digest" data-active="false">
            <h2 id="heading-digest"><i class="bi bi-file-text"></i> Daily Digest</h2>
            <div class="digest-box">{{ digest.digest_text }}</div>
            <div style="margin-top:1rem; display:flex; gap:.75rem; justify-content:flex-end; flex-wrap:wrap;">
                <button class="block-action" style="background:var(--grad-gold); color:var(--text-inverse);" onclick="window.print()"><i class="bi bi-printer"></i> PRINT</button>
                <button class="block-action" onclick="downloadDigest()"><i class="bi bi-download"></i> DOWNLOAD</button>
            </div>
        </section>
        {% endif %}

        <section class="panel" id="panel-archive" aria-labelledby="heading-archive" data-active="false">
            <h2 id="heading-archive"><i class="bi bi-archive"></i> Recent Archive</h2>
            <div style="display: grid; gap: .75rem;">
                {% for recent_date in recent_dates[:5] %}
                <div class="archive-item" onclick="location.href='/?date_param={{ recent_date }}'">
                    <div>
                        <div style="font-weight:600;">{{ recent_date.strftime('%A, %B %d') }}</div>
                        <div style="font-size:.7rem; color:var(--text-tertiary);">{{ recent_date.year }}</div>
                    </div>
                    <i class="bi bi-chevron-right"></i>
                </div>
                {% endfor %}
            </div>
        </section>
    </main>

    <script>
        const hub = document.getElementById('hub');
        const orbitButtons = Array.from(document.querySelectorAll('.orbit-btn'));
        const panels = Array.from(document.querySelectorAll('.panel'));
        const svg = document.querySelector('.hub-links');
        const hubSize = () => ({ x: hub.offsetLeft + hub.offsetWidth / 2, y: hub.offsetTop + hub.offsetHeight / 2 });
        let linkLines = [];
        let hubOpen = false;

        function buildLinkLines() {
            svg.innerHTML = '';
            linkLines = orbitButtons.map(btn => {
                const line = document.createElementNS('http://www.w3.org/2000/svg','line');
                line.setAttribute('stroke-linecap','round');
                line.setAttribute('pathLength','200');
                svg.appendChild(line);
                return { btn, line };
            });
        }

        function positionOrbitButtons() {
            const radius = 140; // distance from hub center
            const wrapperRect = document.querySelector('.hub-wrapper').getBoundingClientRect();
            const cx = wrapperRect.width / 2; // center relative to wrapper
            const cy = wrapperRect.height / 2;
            
            orbitButtons.forEach((btn, i) => {
                const angle = (Math.PI * 2 / orbitButtons.length) * i - Math.PI / 2; // start at top
                const x = cx + radius * Math.cos(angle) - (btn.offsetWidth / 2);
                const y = cy + radius * Math.sin(angle) - (btn.offsetHeight / 2);
                btn.style.left = x + 'px';
                btn.style.top = y + 'px';
            });
            
            // update lines (SVG coordinates relative to wrapper)
            linkLines.forEach(({ btn, line }) => {
                const bx = parseFloat(btn.style.left) + (btn.offsetWidth / 2);
                const by = parseFloat(btn.style.top) + (btn.offsetHeight / 2);
                line.setAttribute('x1', cx);
                line.setAttribute('y1', cy);
                line.setAttribute('x2', bx);
                line.setAttribute('y2', by);
            });
        }

        function toggleHub(forceState=null) {
            hubOpen = forceState !== null ? forceState : !hubOpen;
            hub.classList.toggle('expanded', hubOpen);
            hub.setAttribute('aria-expanded', hubOpen);
            orbitButtons.forEach((b, idx) => {
                if (hubOpen) {
                    b.setAttribute('data-visible','true');
                    b.style.transitionDelay = (idx * 60) + 'ms';
                } else {
                    b.removeAttribute('data-visible');
                    b.style.transitionDelay = '0ms';
                }
            });
            linkLines.forEach(({ line }, idx) => {
                if (hubOpen) {
                    line.setAttribute('data-visible','true');
                    line.style.transitionDelay = (idx * 60) + 'ms';
                } else {
                    line.removeAttribute('data-visible');
                    line.style.transitionDelay = '0ms';
                }
            });
            if (!hubOpen) clearActivePanels();
        }

        function clearActivePanels() { panels.forEach(p => p.dataset.active = 'false'); }

        const hubStage = document.getElementById('hub-stage');

        function collapseHero() {
            if (hubStage && !hubStage.classList.contains('hub-stage--collapsed')) {
                hubStage.classList.add('hub-stage--collapsed');
            }
        }

        function showPanel(id) {
            clearActivePanels();
            const el = document.getElementById('panel-' + id);
            if (el) {
                el.dataset.active = 'true';
                localStorage.setItem('lastPanel', id);
                el.scrollIntoView({behavior:'smooth', block:'start'});
                collapseHero();
            }
        }

        orbitButtons.forEach(btn => btn.addEventListener('click', e => { e.stopPropagation(); showPanel(btn.dataset.panel); }));
        hub.addEventListener('click', e => { e.stopPropagation(); toggleHub(); });

        function restoreLastPanel() {
            const last = localStorage.getItem('lastPanel');
            if (last && document.getElementById('panel-' + last)) {
                toggleHub(true);
                showPanel(last);
                collapseHero();
            }
        }

        function showBlockDetail(blockId) { window.location.href = '/block/' + blockId; }

        function downloadDigest() {
            const digestEl = document.querySelector('#panel-digest .digest-box');
            if(!digestEl) return;
            const digestText = digestEl.textContent;
            const blob = new Blob([digestText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const viewDate = document.body.getAttribute('data-view-date');
            a.download = `daily-digest-${viewDate}.txt`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        }

        // Outside click + esc
        document.addEventListener('click', e => { if (hubOpen && !e.target.closest('.hub-wrapper')) toggleHub(false); });
        document.addEventListener('keydown', e => { if (e.key === 'Escape' && hubOpen) toggleHub(false); });

        // Auto-refresh (only when hub closed and today)
        const isToday = document.body.getAttribute('data-is-today') === '1';
        if (isToday) {
            setInterval(() => { if (!hubOpen) window.location.reload(); }, 120000);
        }

        window.addEventListener('resize', positionOrbitButtons);
        window.addEventListener('load', () => {
            buildLinkLines();
            positionOrbitButtons();
            restoreLastPanel();
            document.querySelectorAll('.block-action[data-block-id]').forEach(btn => {
                btn.addEventListener('click', e => {
                    const id = parseInt(btn.getAttribute('data-block-id'));
                    if (!isNaN(id)) showBlockDetail(id);
                });
            });
        });
    </script>
</body>
</html>
