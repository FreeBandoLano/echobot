{% extends "base.html" %}

{% block title %}Government Radio Synopsis{% endblock %}

{% block nav_today %}app-nav__link--active{% endblock %}

{% block header_extra %}
    <div class="app-date">
        <i class="bi bi-calendar3"></i> {{ view_date.strftime('%B %d, %Y') }}
        {% if is_today %}<span class="app-live">● LIVE</span>{% endif %}
    </div>
{% endblock %}

{% block body_attrs %} data-is-today="{{ 1 if is_today else 0 }}" data-view-date="{{ view_date.strftime('%Y-%m-%d') }}"{% endblock %}

{% block head_extra %}
<style>
    /* Minimal override helpers (panel print + utility spacing if needed) */
    @media print { .hub-wrapper, .orbit-btn { display: none !important; } }
</style>
{% endblock %}

{% block content %}
    <div class="hub-stage" id="hub-stage">
    <div class="hub-wrapper">
            <div class="hub-core" id="hub" data-state="idle" tabindex="0" aria-haspopup="true" aria-expanded="false">
                <i class="bi bi-grid-3x3-gap hub-icon"></i>
                <div class="hub-label">Control Hub</div>
                <div class="hub-ring" aria-hidden="true"></div>
            </div>
            <svg class="hub-links" viewBox="0 0 340 340" preserveAspectRatio="xMidYMid meet" aria-hidden="true"></svg>
            <!-- Orbit buttons (positioned via JS) -->
            <button class="orbit-btn" data-panel="overview" aria-label="Overview">
                <i class="bi bi-graph-up orbit-icon"></i><span>Overview</span>
            </button>
            <button class="orbit-btn" data-panel="blocks" aria-label="Blocks">
                <i class="bi bi-list-ul orbit-icon"></i><span>Blocks</span>
            </button>
            <button class="orbit-btn" data-panel="digest" aria-label="Digest">
                <i class="bi bi-file-text orbit-icon"></i><span>Digest</span>
            </button>
            <button class="orbit-btn" data-panel="archive" aria-label="Archive">
                <i class="bi bi-archive orbit-icon"></i><span>Archive</span>
            </button>
            </div>
        </div>

        <!-- Panels -->
        <section class="panel" id="panel-overview" aria-labelledby="heading-overview" data-active="false">
            <div class="d-flex" style="justify-content:space-between; align-items:center; gap:.5rem; margin:.25rem 0 0.75rem; flex-wrap:wrap;">
                <div class="btn-group" role="group" aria-label="Date navigation" style="flex:0 0 auto;">
                    <a class="block-action" href="/?date_param={{ prev_date }}" {% if not prev_date %}aria-disabled="true" style="opacity:.5; pointer-events:none;"{% endif %}><i class="bi bi-chevron-left"></i> Prev</a>
                    <a class="block-action" href="/">Today</a>
                    <a class="block-action" href="/?date_param={{ next_date }}" {% if not next_date %}aria-disabled="true" style="opacity:.5; pointer-events:none;"{% endif %}>Next <i class="bi bi-chevron-right"></i></a>
                </div>
                <div class="d-flex align-items-center" style="gap:.5rem; flex:1 1 auto; justify-content:flex-end;">
                    <label for="jumpDate" class="small text-muted" style="font-size:.6rem; letter-spacing:.08em;">Jump to</label>
                    <input id="jumpDate" type="date" class="form-control" style="max-width: 170px; height:28px; padding:.1rem .35rem; font-size:.7rem;" value="{{ view_date.strftime('%Y-%m-%d') }}" />
                </div>
                <div class="small text-muted" style="font-size:.6rem; letter-spacing:.08em; flex:1 1 100%; text-align:right;">
                    Shortcuts: ←/→ change day · T go today · R refresh
                </div>
            </div>
            <h2 id="heading-overview"><i class="bi bi-graph-up"></i> Today's Overview</h2>
            <div class="status-grid">
                <div class="status-card">
                    <div class="status-icon"><i class="bi bi-check-circle"></i></div>
                    <div class="status-value">{{ stats.completed_blocks }}</div>
                    <div class="status-label">Completed</div>
                </div>
                <div class="status-card">
                    <div class="status-icon"><i class="bi bi-collection"></i></div>
                    <div class="status-value">{{ stats.total_blocks }}</div>
                    <div class="status-label">Total Blocks</div>
                </div>
                <div class="status-card">
                    <div class="status-icon"><i class="bi bi-people"></i></div>
                    <div class="status-value">{{ stats.total_callers }}</div>
                    <div class="status-label">Callers</div>
                </div>
                <div class="status-card">
                    <div class="status-icon"><i class="bi bi-percent"></i></div>
                    <div class="status-value">{{ stats.completion_rate }}%</div>
                    <div class="status-label">Progress</div>
                </div>
                {% if filler_today and filler_today.total_seconds is not defined %}{% endif %}
                {% if filler_today %}
                <div class="status-card" title="Filler (ads/jingles/news inserts) share of total spoken duration">
                    <div class="status-icon"><i class="bi bi-music-note-beamed"></i></div>
                    <div class="status-value">{{ filler_today.filler_pct }}%</div>
                    <div class="status-label">Filler Share</div>
                </div>
                    {% endif %}
                </div>
        </section>

        <section class="panel" id="panel-blocks" aria-labelledby="heading-blocks" data-active="false">
            <h2 id="heading-blocks"><i class="bi bi-list-ul"></i> Program Blocks</h2>

            {% for prog_key in programs %}
                {% set prog_blocks = blocks | selectattr('program_name', 'equalto', config.PROGRAMS[prog_key].name) | list %}
                {% if prog_blocks %}
                    <div class="program-section" style="margin-bottom: 1.5rem;">
                        <h3 style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--color-border); display: flex; align-items: center; gap: 0.5rem;">
                            <i class="bi bi-broadcast"></i>
                            <span>{{ config.PROGRAMS[prog_key].name }}</span>
                            <span style="font-size: 0.75rem; opacity: 0.6; font-weight: normal;">{{ config.PROGRAMS[prog_key].station }}</span>
                        </h3>

                {% for block in prog_blocks %}
            <div class="block-summary" data-collapsed="true">
                <div class="block-header">
                    <div class="block-title">Block {{ block.block_code }} - {{ block.block_name }}</div>
                    <div style="display:flex; align-items:center; gap:.4rem;">
                        <div class="block-status" data-state="{{ 'completed' if block.status == 'completed' else 'processing' if block.status in ['recording','transcribing','summarizing'] else 'pending' }}">
                            {% if block.status == 'completed' %}
                                <i class="bi bi-check-circle"></i>
                            {% elif block.status in ['recording','transcribing','summarizing'] %}
                                <i class="bi bi-arrow-clockwise"></i>
                            {% else %}
                                <i class="bi bi-clock"></i>
                            {% endif %}
                            {{ block.status.title() if block.status != 'completed' else 'Complete' }}
                        </div>
                        <button class="block-toggle" type="button" aria-label="Toggle details" tabindex="0"><i class="bi bi-chevron-down"></i></button>
                    </div>
                    </div>
                <div class="block-collapsible">
                        {% if block.summary %}
                    {% set clean_summary = block.summary.summary_text.split('{')[0].strip() if '{' in block.summary.summary_text else block.summary.summary_text %}
                    <p class="block-body">{{ clean_summary[:200] }}{% if clean_summary|length > 200 %}...{% endif %}</p>

                    <!-- Quick highlights from emergent data -->
                    {% if block.summary.raw_json %}
                        {% set emergent_data = block.summary.raw_json if block.summary.raw_json is mapping else {} %}

                        <!-- Key themes preview -->
                        {% if emergent_data.key_themes %}
                            <div class="block-themes" style="margin:.5rem 0; display:flex; gap:.4rem; flex-wrap:wrap;">
                                {% for theme in emergent_data.key_themes[:3] %}
                                    <span style="background:var(--color-overlay); border:1px solid var(--color-border); padding:.25rem .5rem; border-radius:var(--radius-pill); font-size:.6rem; letter-spacing:.08em; color:var(--text-tertiary);">{{ theme.title }}</span>
                                {% endfor %}
                                {% if emergent_data.key_themes|length > 3 %}
                                    <span style="background:var(--color-overlay); border:1px solid var(--color-border); padding:.25rem .5rem; border-radius:var(--radius-pill); font-size:.6rem; letter-spacing:.08em; color:var(--text-tertiary); opacity:.6;">+{{ emergent_data.key_themes|length - 3 }} more</span>
                                {% endif %}
                            </div>
                        {% endif %}

                        <!-- Quick alerts for high priority items -->
                        {% if emergent_data.public_concerns %}
                            {% for concern in emergent_data.public_concerns %}
                                {% if concern.urgency == 'high' %}
                                    <div style="background:rgba(220,53,69,0.1); border:1px solid rgba(220,53,69,0.3); padding:.4rem .6rem; border-radius:var(--radius-sm); margin:.4rem 0; font-size:.65rem;">
                                        <i class="bi bi-exclamation-triangle" style="color:#dc3545;"></i> <strong>High Priority:</strong> {{ concern.topic }}
                                    </div>
                                {% endif %}
                            {% endfor %}
                        {% endif %}

                        {% if emergent_data.actions %}
                            {% for action in emergent_data.actions %}
                                {% if action.urgency == 'high' %}
                                    <div style="background:rgba(255,193,7,0.1); border:1px solid rgba(255,193,7,0.3); padding:.4rem .6rem; border-radius:var(--radius-sm); margin:.4rem 0; font-size:.65rem;">
                                        <i class="bi bi-lightning" style="color:#ffc107;"></i> <strong>Action Required:</strong> {{ action.who }} - {{ action.what[:50] }}{% if action.what|length > 50 %}...{% endif %}
                                    </div>
                                {% endif %}
                            {% endfor %}
                        {% endif %}

                        <!-- Official announcements highlight -->
                        {% if emergent_data.official_announcements %}
                            <div style="background:rgba(40,167,69,0.1); border:1px solid rgba(40,167,69,0.3); padding:.4rem .6rem; border-radius:var(--radius-sm); margin:.4rem 0; font-size:.65rem;">
                                <i class="bi bi-megaphone" style="color:#28a745;"></i> <strong>{{ emergent_data.official_announcements|length }} Official Announcement{{ 's' if emergent_data.official_announcements|length > 1 else '' }}</strong>
                            </div>
                        {% endif %}
                    {% endif %}

                    <!-- Fallback to emergent_themes if raw_json processing fails -->
                    {% if block.emergent_themes and not block.summary.raw_json %}
                        <div class="block-themes" style="margin:.5rem 0; display:flex; gap:.4rem; flex-wrap:wrap;">
                            {% for theme in block.emergent_themes %}
                                <span style="background:var(--color-overlay); border:1px solid var(--color-border); padding:.25rem .5rem; border-radius:var(--radius-pill); font-size:.6rem; letter-spacing:.08em; color:var(--text-tertiary);">{{ theme }}</span>
                                    {% endfor %}
                        </div>
                            {% endif %}

                    <div class="block-footer">
                        <span><i class="bi bi-people"></i> {{ block.summary.caller_count or 0 }} callers</span>
                        {% if block.duration_minutes %}
                            <span><i class="bi bi-clock"></i> {{ block.duration_minutes }}min</span>
                        {% endif %}
                        <button class="block-action" data-block-id="{{ block.id }}">DETAILS</button>
                            </div>
                        {% else %}
                    <p class="block-body">
                        {% if block.status == 'pending' %}
                            <i class="bi bi-clock"></i> Scheduled for {{ block.start_time }}
                        {% else %}
                            <i class="bi bi-hourglass-split"></i> Processing...
                            {% endif %}
                    </p>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                    </div>
                {% endif %}
            {% endfor %}
        </section>

                {% if program_digests %}
        <!-- Program-Specific Digests -->
        <section class="panel" id="panel-digest" aria-labelledby="heading-digest" data-active="false">
            <h2 id="heading-digest"><i class="bi bi-file-text"></i> Daily Intelligence Digests</h2>

            {% for prog_digest in program_digests %}
            <div class="digest-program-section mb-4">
                <h3 class="program-digest-title mb-3">
                    <i class="bi bi-broadcast"></i> {{ prog_digest.program_name }}
                </h3>
                <div class="digest-box">
                    <pre style="white-space: pre-wrap; word-wrap: break-word;">{{ prog_digest.content }}</pre>
                </div>
            </div>
            {% endfor %}
        </section>
        {% elif digest %}
        <!-- Legacy single digest (backward compatibility) -->
        <section class="panel" id="panel-digest" aria-labelledby="heading-digest" data-active="false">
            <h2 id="heading-digest"><i class="bi bi-file-text"></i> Daily Intelligence Digest</h2>

            {% if digest.digest_text.startswith('ENHANCED DAILY INTELLIGENCE BRIEFING') %}
            <!-- Enhanced structured digest display -->
            <div class="enhanced-digest">
                <div class="digest-header">
                    <div class="classification-label">INTERNAL GOVERNMENT USE</div>
                    <div class="digest-meta">
                        <span><i class="bi bi-calendar3"></i> {{ view_date.strftime('%B %d, %Y') }}</span>
                        <span><i class="bi bi-people"></i> {{ stats.total_callers }} Callers</span>
                        <span><i class="bi bi-collection"></i> {{ stats.completed_blocks }} Blocks</span>
                        {% if digest.programs_included %}
                            <span><i class="bi bi-broadcast"></i> {{ digest.programs_included|length }} Program{{ 's' if digest.programs_included|length > 1 else '' }}</span>
                        {% endif %}
                    </div>
                </div>

                <div class="digest-content">
                    <!-- Parse and display structured sections -->
                    {% set sections = digest.digest_text.split('## ') %}
                    {% for section in sections[1:] %}
                        {% set section_parts = section.split('\n\n', 1) %}
                        {% if section_parts|length > 1 %}
                        <div class="digest-section">
                            <h3 class="section-title">{{ section_parts[0] }}</h3>
                            <div class="section-content">{{ section_parts[1]|replace('\n', '<br>')|safe }}</div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% else %}
            <!-- Standard digest display -->
            <div class="digest-box standard-digest">{{ digest.digest_text }}</div>
            {% endif %}

            <div style="margin-top:1rem; display:flex; gap:.75rem; justify-content:flex-end; flex-wrap:wrap;">
                <button class="block-action" style="background:var(--grad-gold); color:var(--text-inverse);" onclick="window.print()"><i class="bi bi-printer"></i> PRINT</button>
                <button class="block-action" onclick="downloadDigest()"><i class="bi bi-download"></i> DOWNLOAD</button>
            </div>
        </section>
                {% endif %}

        <section class="panel" id="panel-archive" aria-labelledby="heading-archive" data-active="false">
            <h2 id="heading-archive"><i class="bi bi-archive"></i> Recent Archive</h2>
            <div style="display: grid; gap: .75rem;">
                {% for recent_date in recent_dates[:5] %}
                <div class="archive-item" onclick="location.href='/?date_param={{ recent_date }}'">
                    <div>
                        <div style="font-weight:600;">{{ recent_date.strftime('%A, %B %d') }}</div>
                        <div style="font-size:.7rem; color:var(--text-tertiary);">{{ recent_date.year }}</div>
                    </div>
                    <i class="bi bi-chevron-right"></i>
                                </div>
                            {% endfor %}
                        </div>
        </section>
{% endblock %}

{% block mobile_action_bar %}
    <!-- Mobile Action Bar -->
    <nav class="mobile-action-bar" aria-label="Quick actions">
        <button data-nav="overview"><i class="bi bi-graph-up"></i><span>Overview</span></button>
        <button data-nav="blocks"><i class="bi bi-list-ul"></i><span>Blocks</span></button>
        {% if digest %}<button data-nav="digest"><i class="bi bi-file-text"></i><span>Digest</span></button>{% endif %}
        <button data-nav="archive"><i class="bi bi-archive"></i><span>Archive</span></button>
        <button data-refresh><i class="bi bi-arrow-repeat"></i><span>Refresh</span></button>
    </nav>
{% endblock %}

{% block scripts %}
<script>
    const hub = document.getElementById('hub');
    const orbitButtons = Array.from(document.querySelectorAll('.orbit-btn'));
    const panels = Array.from(document.querySelectorAll('.panel'));
    const svg = document.querySelector('.hub-links');
    const hubSize = () => ({ x: hub.offsetLeft + hub.offsetWidth / 2, y: hub.offsetTop + hub.offsetHeight / 2 });
    let linkLines = [];
    let hubOpen = false;

    function buildLinkLines() {
        svg.innerHTML = '';
        linkLines = orbitButtons.map(btn => {
            const line = document.createElementNS('http://www.w3.org/2000/svg','line');
            line.setAttribute('stroke-linecap','round');
            line.setAttribute('pathLength','200');
            svg.appendChild(line);
            return { btn, line };
        });
    }

    function positionOrbitButtons() {
        const radius = 140; // distance from hub center
        const wrapperRect = document.querySelector('.hub-wrapper').getBoundingClientRect();
        const cx = wrapperRect.width / 2; // center relative to wrapper
        const cy = wrapperRect.height / 2;

        orbitButtons.forEach((btn, i) => {
            const angle = (Math.PI * 2 / orbitButtons.length) * i - Math.PI / 2; // start at top
            const x = cx + radius * Math.cos(angle) - (btn.offsetWidth / 2);
            const y = cy + radius * Math.sin(angle) - (btn.offsetHeight / 2);
            btn.style.left = x + 'px';
            btn.style.top = y + 'px';
        });

        // update lines (SVG coordinates relative to wrapper)
        linkLines.forEach(({ btn, line }) => {
            const bx = parseFloat(btn.style.left) + (btn.offsetWidth / 2);
            const by = parseFloat(btn.style.top) + (btn.offsetHeight / 2);
            line.setAttribute('x1', cx);
            line.setAttribute('y1', cy);
            line.setAttribute('x2', bx);
            line.setAttribute('y2', by);
        });
    }

    function toggleHub(forceState=null) {
        hubOpen = forceState !== null ? forceState : !hubOpen;
        hub.classList.toggle('expanded', hubOpen);
        hub.setAttribute('aria-expanded', hubOpen);
        orbitButtons.forEach((b, idx) => {
            if (hubOpen) {
                b.setAttribute('data-visible','true');
                b.style.transitionDelay = (idx * 60) + 'ms';
            } else {
                b.removeAttribute('data-visible');
                b.style.transitionDelay = '0ms';
            }
        });
        linkLines.forEach(({ line }, idx) => {
            if (hubOpen) {
                line.setAttribute('data-visible','true');
                line.style.transitionDelay = (idx * 60) + 'ms';
            } else {
                line.removeAttribute('data-visible');
                line.style.transitionDelay = '0ms';
            }
        });
        if (!hubOpen) clearActivePanels();
    }

    function clearActivePanels() { panels.forEach(p => p.dataset.active = 'false'); }

    const hubStage = document.getElementById('hub-stage');

    function collapseHero() {
        if (hubStage && !hubStage.classList.contains('hub-stage--collapsed')) {
            hubStage.classList.add('hub-stage--collapsed');
        }
    }

    function showPanel(id) {
        clearActivePanels();
        const el = document.getElementById('panel-' + id);
        if (el) {
            el.dataset.active = 'true';
            localStorage.setItem('lastPanel', id);
            el.scrollIntoView({behavior:'smooth', block:'start'});
            collapseHero();
        }
    }

    orbitButtons.forEach(btn => btn.addEventListener('click', e => { e.stopPropagation(); showPanel(btn.dataset.panel); }));
    hub.addEventListener('click', e => { e.stopPropagation(); toggleHub(); });

    function restoreLastPanel() {
        const last = localStorage.getItem('lastPanel');
        if (last && document.getElementById('panel-' + last)) {
            toggleHub(true);
            showPanel(last);
            collapseHero();
        }
    }

    function showBlockDetail(blockId) { window.location.href = '/block/' + blockId; }

    function downloadDigest() {
        const digestEl = document.querySelector('#panel-digest .digest-box');
        if(!digestEl) return;
        const digestText = digestEl.textContent;
        const blob = new Blob([digestText], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const viewDate = document.body.getAttribute('data-view-date');
        a.download = `daily-digest-${viewDate}.txt`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    }

    // Outside click + esc
    document.addEventListener('click', e => { if (hubOpen && !e.target.closest('.hub-wrapper')) toggleHub(false); });
    document.addEventListener('keydown', e => { if (e.key === 'Escape' && hubOpen) toggleHub(false); });

    // Auto-refresh (only when hub closed and today)
    const isToday = document.body.getAttribute('data-is-today') === '1';
    if (isToday) {
        setInterval(() => { if (!hubOpen) window.location.reload(); }, 120000);
    }

window.addEventListener('resize', positionOrbitButtons);
    window.addEventListener('load', () => {
        buildLinkLines();
        positionOrbitButtons();
        restoreLastPanel();
        document.querySelectorAll('.block-action[data-block-id]').forEach(btn => {
            btn.addEventListener('click', e => {
                const id = parseInt(btn.getAttribute('data-block-id'));
                if (!isNaN(id)) showBlockDetail(id);
            });
        });
        // Make entire block card clickable (excluding explicit buttons/toggles)
        document.querySelectorAll('.block-summary').forEach(card => {
            card.addEventListener('click', (e) => {
                if (e.target.closest('.block-toggle') || e.target.closest('button') || e.target.tagName.toLowerCase() === 'a') return;
                const btn = card.querySelector('.block-action[data-block-id]');
                if (btn) {
                    const id = parseInt(btn.getAttribute('data-block-id'));
                    if (!isNaN(id)) showBlockDetail(id);
                }
            });
        });
        // Mobile action bar wiring
        const mbar = document.querySelector('.mobile-action-bar');
        if(mbar){
            mbar.querySelectorAll('button[data-nav]').forEach(btn=>{
                btn.addEventListener('click', ()=>{
                    const panel = btn.getAttribute('data-nav');
                    showPanel(panel);
                    if(hubOpen) toggleHub(false);
                    window.scrollTo({top:0,behavior:'smooth'});
                });
            });
            const rb = mbar.querySelector('button[data-refresh]');
            if(rb) rb.addEventListener('click', ()=>window.location.reload());
        }
        // Collapsible block summaries (mobile first)
        const mq = window.matchMedia('(max-width:760px)');
        function applyBlockCollapse(){
           const small = mq.matches;
           document.querySelectorAll('.block-summary').forEach(card=>{
               const coll = card.querySelector('.block-collapsible');
               const toggle = card.querySelector('.block-toggle i');
               if(!coll) return;
               if(small){
                   const collapsed = card.getAttribute('data-collapsed') === 'true';
                   coll.style.display = collapsed ? 'none':'block';
                   toggle.className = collapsed ? 'bi bi-chevron-down':'bi bi-chevron-up';
               } else {
                   coll.style.display = 'block';
                   toggle.className = 'bi bi-chevron-up';
               }
           });
        }
        document.querySelectorAll('.block-summary .block-toggle').forEach(btn=>{
           btn.addEventListener('click', () => {
               const card = btn.closest('.block-summary');
               const state = card.getAttribute('data-collapsed') === 'true';
               card.setAttribute('data-collapsed', state ? 'false':'true');
               applyBlockCollapse();
           });
        });
        mq.addEventListener('change', applyBlockCollapse);
        applyBlockCollapse();
    });

    // Keyboard shortcuts: left/right for prev/next day, T for today, R refresh, 1-4 panels
    document.addEventListener('keydown', (e) => {
        const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : '';
        if (tag === 'input' || tag === 'textarea') return;
        if (e.key === 'ArrowLeft' && '{{ prev_date }}' !== 'None') {
            window.location.href='/?date_param={{ prev_date }}';
        } else if (e.key === 'ArrowRight' && '{{ next_date }}' !== 'None') {
            window.location.href='/?date_param={{ next_date }}';
        } else if (e.key.toLowerCase() === 't') {
            window.location.href='/';
        } else if (e.key.toLowerCase() === 'r') {
            window.location.reload();
        } else if (e.key === '1') {
            showPanel('overview');
        } else if (e.key === '2') {
            showPanel('blocks');
        } else if (e.key === '3' && document.getElementById('panel-digest')) {
            showPanel('digest');
        } else if (e.key === '4') {
            showPanel('archive');
        }
    });
    // Date jump wiring
    const jump = document.getElementById('jumpDate');
    if (jump) {
        jump.addEventListener('change', () => {
            if (jump.value) window.location.href='/?date_param=' + encodeURIComponent(jump.value);
        });
    }
</script>
<style>
/* Collapsible block summaries */
@media (max-width:760px){
  .block-summary{padding:1rem .9rem 1rem;}
  .block-summary .block-toggle{background:var(--color-panel-alt); border:1px solid var(--color-border); color:var(--text-tertiary); width:32px; height:32px; display:flex; align-items:center; justify-content:center; border-radius:var(--radius-pill); cursor:pointer; font-size:.9rem; }
  .block-summary .block-toggle:hover{color:var(--text-primary); border-color:var(--color-border-strong);}
}
@media (min-width:761px){ .block-summary .block-toggle{ display:none; } }
</style>
<style>
/* Mobile Action Bar */
.mobile-action-bar{display:none;}
@media (max-width:700px){
    .mobile-action-bar{position:fixed; bottom:0; left:0; right:0; z-index:40; background:rgba(18,24,35,0.92); backdrop-filter:blur(10px); border-top:1px solid var(--color-border); display:flex; justify-content:space-around; padding:.35rem .25rem;}
    .mobile-action-bar button{background:none; border:none; color:var(--text-tertiary); font-size:.55rem; display:flex; flex-direction:column; align-items:center; gap:.15rem; letter-spacing:.08em; font-weight:600; padding:.3rem .5rem; border-radius:var(--radius-sm);}
    .mobile-action-bar button i{font-size:1.15rem;}
    .mobile-action-bar button:active, .mobile-action-bar button:hover{color:var(--text-primary); background:var(--color-panel-alt);}
    body{padding-bottom:70px;} /* reserve space */
}
</style>
{% endblock %}
