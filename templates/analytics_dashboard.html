<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Executive Analytics Dashboard • Radio Synopsis</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="/static/css/theme.css">
  <style>
    /* Executive Dashboard Specific Styles */
    .executive-view {
      background: var(--grad-bg);
      min-height: 100vh;
      padding-bottom: 3rem;
    }

    .executive-header {
      background: linear-gradient(135deg, var(--color-brand) 0%, var(--color-brand-accent) 100%);
      border-bottom: 3px solid var(--color-gold);
      padding: 2rem 0;
      margin-bottom: 2rem;
      color: white;
      box-shadow: var(--elev-2);
    }

    .executive-header h1 {
      font-size: 1.75rem;
      font-weight: 700;
      letter-spacing: 0.5px;
      margin: 0;
      text-transform: uppercase;
    }

    .executive-header .subtitle {
      font-size: 0.9rem;
      opacity: 0.9;
      letter-spacing: 0.1em;
      margin-top: 0.5rem;
    }

    .classification-badge {
      display: inline-block;
      background: rgba(255, 255, 255, 0.2);
      padding: 0.25rem 0.75rem;
      border-radius: var(--radius-pill);
      font-size: 0.7rem;
      font-weight: 700;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      margin-bottom: 1rem;
    }

    .dashboard-section {
      background: var(--color-panel);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: var(--elev-1);
      position: relative;
    }

    .dashboard-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--grad-active);
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--color-border);
    }

    .section-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--color-gold);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin: 0;
    }

    .section-title i {
      font-size: 1.5rem;
      opacity: 0.8;
    }

    /* Sentiment Overview Styles */
    .sentiment-card {
      background: var(--color-panel-alt);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: 1.5rem;
      text-align: center;
      position: relative;
      overflow: hidden;
      transition: all var(--dur-ui) var(--ease-standard);
    }

    .sentiment-card:hover {
      border-color: var(--color-gold);
      box-shadow: var(--elev-2);
    }

    .sentiment-label {
      font-size: 0.7rem;
      font-weight: 600;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--text-tertiary);
      margin-bottom: 0.75rem;
    }

    .sentiment-value {
      font-size: 2.5rem;
      font-weight: 700;
      line-height: 1.1;
      margin-bottom: 0.5rem;
    }

    .sentiment-positive { color: var(--color-success); }
    .sentiment-negative { color: var(--color-danger); }
    .sentiment-neutral { color: var(--color-warn); }

    .sentiment-text {
      font-size: 0.85rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    /* Alert Section Styles */
    .alert-section {
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }

    .issue-alert {
      background: var(--color-panel-alt);
      border: 2px solid;
      border-radius: var(--radius-md);
      padding: 1.25rem;
      position: relative;
      transition: all var(--dur-ui) var(--ease-standard);
    }

    .issue-alert:hover {
      transform: translateY(-2px);
      box-shadow: var(--elev-2);
    }

    .alert-red {
      border-color: var(--color-danger);
      background: rgba(220, 53, 69, 0.05);
    }

    .alert-orange {
      border-color: var(--color-warn);
      background: rgba(231, 165, 56, 0.05);
    }

    .alert-green {
      border-color: var(--color-success);
      background: rgba(51, 176, 122, 0.05);
    }

    .urgency-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: var(--radius-pill);
      font-size: 0.65rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      margin-bottom: 0.75rem;
    }

    .urgency-high {
      background: var(--color-danger);
      color: white;
    }

    .urgency-medium {
      background: var(--color-warn);
      color: var(--text-inverse);
    }

    .urgency-low {
      background: var(--color-success);
      color: white;
    }

    .issue-topic {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }

    .issue-trajectory {
      font-size: 0.75rem;
      color: var(--text-tertiary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .trajectory-icon {
      font-size: 1rem;
    }

    /* Parish Heatmap Styles */
    .parish-map {
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }

    .parish-card {
      background: var(--color-panel-alt);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: 1rem;
      position: relative;
      transition: all var(--dur-ui) var(--ease-standard);
    }

    .parish-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--elev-2);
    }

    .parish--positive {
      border-color: var(--color-success);
      background: rgba(51, 176, 122, 0.08);
    }

    .parish--negative {
      border-color: var(--color-danger);
      background: rgba(220, 53, 69, 0.08);
    }

    .parish--neutral {
      border-color: var(--color-warn);
      background: rgba(231, 165, 56, 0.08);
    }

    .parish--insufficient {
      border-color: var(--text-faint);
      background: rgba(125, 136, 150, 0.05);
      opacity: 0.6;
    }

    .parish-name {
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .parish-mentions {
      font-size: 0.7rem;
      color: var(--text-tertiary);
      margin-bottom: 0.5rem;
    }

    .parish-sentiment {
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .parish-concern {
      font-size: 0.75rem;
      color: var(--text-secondary);
      font-style: italic;
    }

    /* Policy Category Styles */
    .policy-grid {
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    }

    .policy-card {
      background: var(--color-panel-alt);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: 1rem 1.25rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all var(--dur-ui) var(--ease-standard);
    }

    .policy-card:hover {
      border-color: var(--color-gold);
      background: var(--color-panel);
    }

    .policy-name {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .policy-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .indicator-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    .indicator-positive { background: var(--color-success); }
    .indicator-negative { background: var(--color-danger); }
    .indicator-neutral { background: var(--color-warn); }

    .policy-score {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-secondary);
    }

    /* Export Actions */
    .export-actions {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .export-btn {
      background: var(--grad-active);
      border: none;
      color: white;
      padding: 0.5rem 1.25rem;
      border-radius: var(--radius-pill);
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      cursor: pointer;
      transition: all var(--dur-ui) var(--ease-standard);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .export-btn:hover {
      filter: brightness(1.1);
      box-shadow: var(--elev-2);
      color: white;
    }

    .priority-section {
      background: linear-gradient(135deg, rgba(181, 18, 39, 0.1) 0%, rgba(245, 195, 66, 0.05) 100%);
      border: 2px solid var(--color-gold);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      margin-bottom: 2rem;
    }

    .priority-section h3 {
      color: var(--color-gold);
      font-size: 1rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    @media (max-width: 768px) {
      .executive-header h1 {
        font-size: 1.3rem;
      }

      .dashboard-section {
        padding: 1.25rem;
      }

      .section-title {
        font-size: 1.1rem;
      }

      .sentiment-value {
        font-size: 2rem;
      }

      .export-actions {
        flex-direction: column;
        width: 100%;
      }

      .export-btn {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body class="executive-view">
  <header class="app-header">
    <a href="/" class="app-logo"><i class="bi bi-broadcast"></i> <span>Radio Synopsis</span></a>
    <nav class="app-nav">
      <a href="/" class="app-nav__link">Today</a>
      <a href="/archive" class="app-nav__link">Archive</a>
      <a href="/dashboard/analytics" class="app-nav__link app-nav__link--active">Executive</a>
    </nav>
  </header>

  <main>
    <div class="executive-header">
      <div class="container">
        <span class="classification-badge">Government Intelligence Brief</span>
        <h1><i class="bi bi-shield-check"></i> Executive Analytics Dashboard</h1>
        <p class="subtitle">Public Sentiment Analysis • {{ view_date.strftime('%B %d, %Y') if view_date else 'Current' }}</p>
      </div>
    </div>

    <div class="container">
      <!-- Priority Alerts -->
      {% if analytics.emerging_issues %}
      <div class="priority-section">
        <h3><i class="bi bi-exclamation-triangle-fill"></i> Immediate Attention Required</h3>
        <div class="alert-section">
          {% for issue in analytics.emerging_issues[:3] %}
          <div class="issue-alert {% if issue.urgency >= 0.7 %}alert-red{% elif issue.urgency >= 0.4 %}alert-orange{% else %}alert-green{% endif %}">
            <span class="urgency-badge {% if issue.urgency >= 0.7 %}urgency-high{% elif issue.urgency >= 0.4 %}urgency-medium{% else %}urgency-low{% endif %}">
              {% if issue.urgency >= 0.7 %}HIGH PRIORITY{% elif issue.urgency >= 0.4 %}MEDIUM PRIORITY{% else %}MONITOR{% endif %}
            </span>
            <div class="issue-topic">{{ issue.topic }}</div>
            <div class="issue-trajectory">
              <i class="bi bi-arrow-up-right trajectory-icon" style="color: var(--color-danger);"></i>
              <span>Trajectory: {{ issue.trajectory|capitalize }} ({{ (issue.urgency * 100)|round }}% urgency)</span>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- TACTICAL ANALYTICS CHARTS (Grok-Inspired) -->
      <div class="tactical-bg-pattern" style="padding: 2rem 0;">

        <!-- Row 1: Policy Topics + Sentiment Donut -->
        <div class="row g-4 mb-4">
          <div class="col-lg-6">
            <div class="card tactical-card-simple">
              <div class="card-body" style="position: relative;">
                <div id="policyTopicsChart" style="height: 400px;"></div>
                <div class="chart-loading" id="policyTopicsLoading" style="display: none;">
                  <div class="spinner-border text-info" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-6">
            <div class="card tactical-card-simple">
              <div class="card-body" style="position: relative;">
                <div id="sentimentDonutChart" style="height: 400px;"></div>
                <div class="chart-loading" id="sentimentDonutLoading" style="display: none;">
                  <div class="spinner-border text-info" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Row 2: Topic Sentiment + Parish Radial -->
        <div class="row g-4 mb-4">
          <div class="col-lg-6">
            <div class="card tactical-card-simple">
              <div class="card-body" style="position: relative;">
                <div id="topicSentimentChart" style="height: 500px;"></div>
                <div class="chart-loading" id="topicSentimentLoading" style="display: none;">
                  <div class="spinner-border text-info" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-6">
            <div class="card tactical-card-simple">
              <div class="card-body" style="position: relative;">
                <!-- Parish View Toggle -->
                <div class="btn-group btn-group-sm mb-3" role="group">
                  <button type="button" class="btn btn-outline-info active" id="parishRadialBtn">
                    <i class="bi bi-radar"></i> Radial View
                  </button>
                  <button type="button" class="btn btn-outline-info" id="parishCardsBtn">
                    <i class="bi bi-grid-3x3"></i> Card View
                  </button>
                </div>

                <div id="parishRadialChart" style="height: 500px;"></div>
                <div id="parishCardsView" style="display: none;">
                  <div class="parish-map">
                    {% for parish in analytics.parishes %}
                    <div class="parish-card parish--{{ 'positive' if parish.label == 'Somewhat Positive' or parish.label == 'Strongly Positive' else 'negative' if 'Negative' in parish.label else 'neutral' if parish.mentions >= 5 else 'insufficient' }}">
                      <div class="parish-name">{{ parish.name }}</div>
                      <div class="parish-mentions">{{ parish.mentions }} mention{{ 's' if parish.mentions != 1 else '' }}</div>
                      <div class="parish-sentiment {% if 'Negative' in parish.label %}sentiment-negative{% elif 'Positive' in parish.label %}sentiment-positive{% else %}sentiment-neutral{% endif %}">
                        {{ parish.label }}
                      </div>
                      {% if parish.top_concern %}
                      <div class="parish-concern">Primary: {{ parish.top_concern }}</div>
                      {% endif %}
                    </div>
                    {% endfor %}
                  </div>
                </div>

                <div class="chart-loading" id="parishRadialLoading" style="display: none;">
                  <div class="spinner-border text-info" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- Export Actions -->
      <div class="text-center mb-4">
        <div class="btn-group" role="group">
          <a href="/dashboard/export/pdf?date={{ view_date }}" class="btn btn-outline-info">
            <i class="bi bi-file-pdf"></i> Export PDF
          </a>
          <a href="/dashboard/export/csv?dataset=sentiment&date={{ view_date }}" class="btn btn-outline-info">
            <i class="bi bi-filetype-csv"></i> Export CSV
          </a>
          <a href="/dashboard/export/json?date={{ view_date }}" class="btn btn-outline-info">
            <i class="bi bi-code-square"></i> Export JSON
          </a>
        </div>
      </div>

      <!-- Footer Notes -->
      <div style="margin-top: 3rem; padding: 1.5rem; background: var(--color-panel); border: 1px solid var(--color-border); border-radius: var(--radius-lg); font-size: 0.8rem; color: var(--text-secondary);">
        <h4 style="font-size: 0.9rem; font-weight: 600; color: var(--color-gold); margin-bottom: 0.75rem;">
          <i class="bi bi-info-circle"></i> Methodology
        </h4>
        <p style="margin-bottom: 0.5rem;">
          <strong>Sentiment Analysis:</strong> AI-powered natural language processing analyzing caller discourse tone, word choice, and contextual sentiment.
        </p>
        <p style="margin-bottom: 0.5rem;">
          <strong>Urgency Scoring:</strong> Composite metric based on: mention frequency delta (7-day), emotional intensity markers, call volume spikes, and cross-block persistence.
        </p>
        <p style="margin-bottom: 0;">
          <strong>Data Source:</strong> Down to Brass Tacks (VOB 92.9 FM) • Automated transcription & analysis • Updated daily
        </p>
      </div>
    </div>
  </main>

  <!-- Chart Loading and API Integration -->
  <script>
    // =========================================================================
    // DATE CONFIGURATION
    // =========================================================================
    const VIEW_DATE = '{{ view_date.strftime("%Y-%m-%d") if view_date else "" }}';
    const ANALYTICS_DAYS = 7;

    // Build query string with date support
    function buildAnalyticsQuery(days = ANALYTICS_DAYS) {
      let query = `days=${days}`;
      if (VIEW_DATE) {
        query += `&end_date=${VIEW_DATE}`;
      }
      return query;
    }

    // =========================================================================
    // PARISH VIEW TOGGLE (Radial Chart ↔ Card View)
    // =========================================================================

    const parishRadialBtn = document.getElementById('parishRadialBtn');
    const parishCardsBtn = document.getElementById('parishCardsBtn');
    const parishRadialChart = document.getElementById('parishRadialChart');
    const parishCardsView = document.getElementById('parishCardsView');

    if (parishRadialBtn && parishCardsBtn) {
      parishRadialBtn.addEventListener('click', function() {
        parishRadialChart.style.display = 'block';
        parishCardsView.style.display = 'none';
        this.classList.add('active');
        parishCardsBtn.classList.remove('active');
      });

      parishCardsBtn.addEventListener('click', function() {
        parishRadialChart.style.display = 'none';
        parishCardsView.style.display = 'block';
        this.classList.add('active');
        parishRadialBtn.classList.remove('active');
      });
    }

    // =========================================================================
    // CHART LOADER FUNCTIONS
    // =========================================================================

    /**
     * Load Policy Topics Chart (Horizontal Bars with Colored Borders)
     */
    async function loadPolicyTopicsChart() {
      const loading = document.getElementById('policyTopicsLoading');
      if (!loading) return;

      loading.style.display = 'flex';

      try {
        // Fetch trending topics with category grouping
        const response = await fetch(`/api/analytics/topics/trending?${buildAnalyticsQuery()}`);

        if (!response.ok) {
          throw new Error(`API error: ${response.status}`);
        }

        const data = await response.json();

        // Transform API data to chart format
        // API returns: [{name: "Topic", total_weight: 5.5, blocks: 3}]
        const chartData = data.topics.map(topic => ({
          category: topic.name || topic.category || 'Uncategorized',
          count: topic.blocks || topic.total_weight || 0,
          sentiment: topic.avg_sentiment || 0
        }));

        // Sort by count descending, take top 10
        chartData.sort((a, b) => b.count - a.count);
        const top10 = chartData.slice(0, 10);

        // Handle empty data
        if (top10.length === 0) {
          document.getElementById('policyTopicsChart').innerHTML =
            '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-tertiary);">' +
            '<i class="bi bi-inbox" style="margin-right: 0.5rem; font-size: 1.5rem;"></i> No topic data available for this period' +
            '</div>';
          return;
        }

        // Call chart function from charts.js
        if (typeof EchobotCharts !== 'undefined' && EchobotCharts.createPolicyTopicsChart) {
          EchobotCharts.createPolicyTopicsChart('policyTopicsChart', top10);
        } else {
          console.error('EchobotCharts.createPolicyTopicsChart not found');
        }
      } catch (error) {
        console.error('Failed to load policy topics chart:', error);
        document.getElementById('policyTopicsChart').innerHTML =
          '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--tactical-text-muted);">' +
          '<i class="bi bi-exclamation-triangle" style="margin-right: 0.5rem;"></i> Failed to load chart data' +
          '</div>';
      } finally {
        loading.style.display = 'none';
      }
    }

    /**
     * Load Sentiment Donut Chart (5 Segments with Center Annotation)
     */
    async function loadSentimentDonutChart() {
      const loading = document.getElementById('sentimentDonutLoading');
      if (!loading) return;

      loading.style.display = 'flex';

      try {
        // Fetch sentiment distribution (uses date parameter)
        const response = await fetch(`/api/analytics/sentiment?date=${VIEW_DATE || new Date().toISOString().split('T')[0]}`);

        if (!response.ok) {
          throw new Error(`API error: ${response.status}`);
        }

        const data = await response.json();

        // Transform to 5-segment donut format
        // API returns sentiment_distribution: {"Strongly Positive": N, "Mixed/Neutral": M, ...}
        const dist = data.sentiment_distribution || {};
        const chartData = [
          {
            label: 'Strongly Positive',
            value: dist['Strongly Positive'] || 0,
            color: EchobotCharts.TACTICAL_CONFIG.colors.positive
          },
          {
            label: 'Somewhat Positive',
            value: dist['Somewhat Positive'] || 0,
            color: '#88ff88'
          },
          {
            label: 'Mixed/Neutral',
            value: dist['Mixed/Neutral'] || 0,
            color: EchobotCharts.TACTICAL_CONFIG.colors.neutral
          },
          {
            label: 'Somewhat Negative',
            value: dist['Somewhat Negative'] || 0,
            color: '#ff8844'
          },
          {
            label: 'Strongly Negative',
            value: dist['Strongly Negative'] || 0,
            color: EchobotCharts.TACTICAL_CONFIG.colors.negative
          }
        ];

        const totalCount = chartData.reduce((sum, d) => sum + d.value, 0);

        // Handle empty data
        if (totalCount === 0) {
          document.getElementById('sentimentDonutChart').innerHTML =
            '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-tertiary);">' +
            '<i class="bi bi-inbox" style="margin-right: 0.5rem; font-size: 1.5rem;"></i> No sentiment data available for this date' +
            '</div>';
          return;
        }

        // Call chart function
        if (typeof EchobotCharts !== 'undefined' && EchobotCharts.createSentimentDonut) {
          EchobotCharts.createSentimentDonut('sentimentDonutChart', chartData, totalCount);
        } else {
          console.error('EchobotCharts.createSentimentDonut not found');
        }
      } catch (error) {
        console.error('Failed to load sentiment donut chart:', error);
        document.getElementById('sentimentDonutChart').innerHTML =
          '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--tactical-text-muted);">' +
          '<i class="bi bi-exclamation-triangle" style="margin-right: 0.5rem;"></i> Failed to load chart data' +
          '</div>';
      } finally {
        loading.style.display = 'none';
      }
    }

    /**
     * Load Topic Sentiment Chart (Diverging Bars + Line Overlay)
     */
    async function loadTopicSentimentChart() {
      const loading = document.getElementById('topicSentimentLoading');
      if (!loading) return;

      loading.style.display = 'flex';

      try {
        // Fetch top topics with sentiment data
        const response = await fetch(`/api/analytics/topics/trending?${buildAnalyticsQuery()}`);

        if (!response.ok) {
          throw new Error(`API error: ${response.status}`);
        }

        const data = await response.json();

        // Transform to diverging bar format
        // API returns: [{name: "Topic", total_weight: 5.5, blocks: 3}]
        const chartData = data.topics.map(topic => ({
          topic: topic.name || 'Unknown Topic',
          avgSentiment: topic.avg_sentiment || 0,
          count: topic.blocks || topic.total_weight || 0
        }));

        // Sort by absolute sentiment (most polarizing topics first)
        chartData.sort((a, b) => Math.abs(b.avgSentiment) - Math.abs(a.avgSentiment));
        const top12 = chartData.slice(0, 12);

        // Handle empty data
        if (top12.length === 0) {
          document.getElementById('topicSentimentChart').innerHTML =
            '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-tertiary);">' +
            '<i class="bi bi-inbox" style="margin-right: 0.5rem; font-size: 1.5rem;"></i> No topic sentiment data available' +
            '</div>';
          return;
        }

        // Call chart function
        if (typeof EchobotCharts !== 'undefined' && EchobotCharts.createTopicSentimentChart) {
          EchobotCharts.createTopicSentimentChart('topicSentimentChart', top12);
        } else {
          console.error('EchobotCharts.createTopicSentimentChart not found');
        }
      } catch (error) {
        console.error('Failed to load topic sentiment chart:', error);
        document.getElementById('topicSentimentChart').innerHTML =
          '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--tactical-text-muted);">' +
          '<i class="bi bi-exclamation-triangle" style="margin-right: 0.5rem;"></i> Failed to load chart data' +
          '</div>';
      } finally {
        loading.style.display = 'none';
      }
    }

    /**
     * Load Parish Radial Chart (Polar Bar Chart)
     */
    async function loadParishRadialChart() {
      const loading = document.getElementById('parishRadialLoading');
      if (!loading) return;

      loading.style.display = 'flex';

      try {
        // Fetch parish data
        const response = await fetch(`/api/analytics/parishes?${buildAnalyticsQuery()}`);

        if (!response.ok) {
          throw new Error(`API error: ${response.status}`);
        }

        const data = await response.json();

        // Transform to radial chart format
        // API returns: [{parish: "St. Michael", mention_count: 5, avg_sentiment: 0.3}]
        const chartData = data.parishes.map(p => ({
          parish: p.parish || 'Unknown',
          sentiment: p.avg_sentiment || 0,
          count: p.mention_count || 0
        }));

        // Sort by mention count descending
        chartData.sort((a, b) => b.count - a.count);

        // Handle empty data
        if (chartData.length === 0) {
          document.getElementById('parishRadialChart').innerHTML =
            '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-tertiary);">' +
            '<i class="bi bi-inbox" style="margin-right: 0.5rem; font-size: 1.5rem;"></i> No parish data available for this period' +
            '</div>';
          return;
        }

        // Call chart function
        if (typeof EchobotCharts !== 'undefined' && EchobotCharts.createParishRadialChart) {
          EchobotCharts.createParishRadialChart('parishRadialChart', chartData);
        } else {
          console.error('EchobotCharts.createParishRadialChart not found');
        }
      } catch (error) {
        console.error('Failed to load parish radial chart:', error);
        document.getElementById('parishRadialChart').innerHTML =
          '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--tactical-text-muted);">' +
          '<i class="bi bi-exclamation-triangle" style="margin-right: 0.5rem;"></i> Failed to load chart data' +
          '</div>';
      } finally {
        loading.style.display = 'none';
      }
    }

    // =========================================================================
    // INITIALIZE ALL CHARTS ON PAGE LOAD
    // =========================================================================

    document.addEventListener('DOMContentLoaded', function() {
      console.log('Initializing tactical analytics charts...');

      // Load all 4 charts in parallel
      Promise.all([
        loadPolicyTopicsChart(),
        loadSentimentDonutChart(),
        loadTopicSentimentChart(),
        loadParishRadialChart()
      ]).then(() => {
        console.log('All tactical charts loaded successfully');
      }).catch(error => {
        console.error('Error loading charts:', error);
      });
    });
  </script>

  <!-- Plotly.js for chart rendering -->
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <!-- Echobot Charts library -->
  <script src="/static/js/charts.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
