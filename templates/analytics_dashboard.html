<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Executive Analytics Dashboard • Radio Synopsis</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="/static/css/theme.css">
  <style>
    /* Executive Dashboard Specific Styles */
    .executive-view {
      background: var(--grad-bg);
      min-height: 100vh;
      padding-bottom: 3rem;
    }

    .executive-header {
      background: linear-gradient(135deg, var(--color-brand) 0%, var(--color-brand-accent) 100%);
      border-bottom: 3px solid var(--color-gold);
      padding: 2rem 0;
      margin-bottom: 2rem;
      color: white;
      box-shadow: var(--elev-2);
    }

    .executive-header h1 {
      font-size: 1.75rem;
      font-weight: 700;
      letter-spacing: 0.5px;
      margin: 0;
      text-transform: uppercase;
    }

    .executive-header .subtitle {
      font-size: 0.9rem;
      opacity: 0.9;
      letter-spacing: 0.1em;
      margin-top: 0.5rem;
    }

    .classification-badge {
      display: inline-block;
      background: rgba(255, 255, 255, 0.2);
      padding: 0.25rem 0.75rem;
      border-radius: var(--radius-pill);
      font-size: 0.7rem;
      font-weight: 700;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      margin-bottom: 1rem;
    }

    .dashboard-section {
      background: var(--color-panel);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: var(--elev-1);
      position: relative;
    }

    .dashboard-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--grad-active);
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--color-border);
    }

    .section-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--color-gold);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin: 0;
    }

    .section-title i {
      font-size: 1.5rem;
      opacity: 0.8;
    }

    /* Sentiment Overview Styles */
    .sentiment-card {
      background: var(--color-panel-alt);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: 1.5rem;
      text-align: center;
      position: relative;
      overflow: hidden;
      transition: all var(--dur-ui) var(--ease-standard);
    }

    .sentiment-card:hover {
      border-color: var(--color-gold);
      box-shadow: var(--elev-2);
    }

    .sentiment-label {
      font-size: 0.7rem;
      font-weight: 600;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--text-tertiary);
      margin-bottom: 0.75rem;
    }

    .sentiment-value {
      font-size: 2.5rem;
      font-weight: 700;
      line-height: 1.1;
      margin-bottom: 0.5rem;
    }

    .sentiment-positive { color: var(--color-success); }
    .sentiment-negative { color: var(--color-danger); }
    .sentiment-neutral { color: var(--color-warn); }

    .sentiment-text {
      font-size: 0.85rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    /* Alert Section Styles */
    .alert-section {
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }

    .issue-alert {
      background: var(--color-panel-alt);
      border: 2px solid;
      border-radius: var(--radius-md);
      padding: 1.25rem;
      position: relative;
      transition: all var(--dur-ui) var(--ease-standard);
    }

    .issue-alert:hover {
      transform: translateY(-2px);
      box-shadow: var(--elev-2);
    }

    .alert-red {
      border-color: var(--color-danger);
      background: rgba(220, 53, 69, 0.05);
    }

    .alert-orange {
      border-color: var(--color-warn);
      background: rgba(231, 165, 56, 0.05);
    }

    .alert-green {
      border-color: var(--color-success);
      background: rgba(51, 176, 122, 0.05);
    }

    .urgency-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: var(--radius-pill);
      font-size: 0.65rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      margin-bottom: 0.75rem;
    }

    .urgency-high {
      background: var(--color-danger);
      color: white;
    }

    .urgency-medium {
      background: var(--color-warn);
      color: var(--text-inverse);
    }

    .urgency-low {
      background: var(--color-success);
      color: white;
    }

    .issue-topic {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }

    .issue-trajectory {
      font-size: 0.75rem;
      color: var(--text-tertiary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .trajectory-icon {
      font-size: 1rem;
    }

    /* Parish Heatmap Styles */
    .parish-map {
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }

    .parish-card {
      background: var(--color-panel-alt);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: 1rem;
      position: relative;
      transition: all var(--dur-ui) var(--ease-standard);
    }

    .parish-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--elev-2);
    }

    .parish--positive {
      border-color: var(--color-success);
      background: rgba(51, 176, 122, 0.08);
    }

    .parish--negative {
      border-color: var(--color-danger);
      background: rgba(220, 53, 69, 0.08);
    }

    .parish--neutral {
      border-color: var(--color-warn);
      background: rgba(231, 165, 56, 0.08);
    }

    .parish--insufficient {
      border-color: var(--text-faint);
      background: rgba(125, 136, 150, 0.05);
      opacity: 0.6;
    }

    .parish-name {
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .parish-mentions {
      font-size: 0.7rem;
      color: var(--text-tertiary);
      margin-bottom: 0.5rem;
    }

    .parish-sentiment {
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .parish-concern {
      font-size: 0.75rem;
      color: var(--text-secondary);
      font-style: italic;
    }

    /* Policy Category Styles */
    .policy-grid {
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    }

    .policy-card {
      background: var(--color-panel-alt);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: 1rem 1.25rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all var(--dur-ui) var(--ease-standard);
    }

    .policy-card:hover {
      border-color: var(--color-gold);
      background: var(--color-panel);
    }

    .policy-name {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .policy-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .indicator-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    .indicator-positive { background: var(--color-success); }
    .indicator-negative { background: var(--color-danger); }
    .indicator-neutral { background: var(--color-warn); }

    .policy-score {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-secondary);
    }

    /* Export Actions */
    .export-actions {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .export-btn {
      background: var(--grad-active);
      border: none;
      color: white;
      padding: 0.5rem 1.25rem;
      border-radius: var(--radius-pill);
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      cursor: pointer;
      transition: all var(--dur-ui) var(--ease-standard);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .export-btn:hover {
      filter: brightness(1.1);
      box-shadow: var(--elev-2);
      color: white;
    }

    .priority-section {
      background: linear-gradient(135deg, rgba(181, 18, 39, 0.1) 0%, rgba(245, 195, 66, 0.05) 100%);
      border: 2px solid var(--color-gold);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      margin-bottom: 2rem;
    }

    .priority-section h3 {
      color: var(--color-gold);
      font-size: 1rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    @media (max-width: 768px) {
      .executive-header h1 {
        font-size: 1.3rem;
      }

      .dashboard-section {
        padding: 1.25rem;
      }

      .section-title {
        font-size: 1.1rem;
      }

      .sentiment-value {
        font-size: 2rem;
      }

      .export-actions {
        flex-direction: column;
        width: 100%;
      }

      .export-btn {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body class="exec-dashboard">
  <!-- Executive Header -->
  <header class="exec-header">
    <div class="exec-header-left">
      <span class="exec-badge">Intelligence Brief</span>
      <div>
        <h1 class="exec-title">Executive Analytics Dashboard</h1>
        <p class="exec-subtitle">Public Sentiment Analysis • {{ view_date.strftime('%B %d, %Y') if view_date else 'Current' }}</p>
      </div>
    </div>
    <div class="exec-header-right">
      <a href="/" class="exec-btn"><i class="bi bi-house"></i> Home</a>
      <a href="/dashboard/export/pdf?date={{ view_date }}" class="exec-btn"><i class="bi bi-file-pdf"></i> PDF</a>
      <a href="/dashboard/export/csv?dataset=sentiment&date={{ view_date }}" class="exec-btn"><i class="bi bi-filetype-csv"></i> CSV</a>
      <a href="/dashboard/export/json?date={{ view_date }}" class="exec-btn"><i class="bi bi-code-square"></i> JSON</a>
    </div>
  </header>

  <!-- Key Metrics Bar -->
  <div class="exec-metrics-bar">
    <div class="exec-metric">
      <span class="exec-metric-label">Overall Sentiment</span>
      <span class="exec-metric-value {% if analytics.overall_sentiment.score > 0.1 %}exec-metric-value--positive{% elif analytics.overall_sentiment.score < -0.1 %}exec-metric-value--negative{% else %}exec-metric-value--neutral{% endif %}">
        {{ '%+.2f'|format(analytics.overall_sentiment.score) if analytics.overall_sentiment.score else '—' }}
      </span>
    </div>
    <div class="exec-metric">
      <span class="exec-metric-label">Blocks Analyzed</span>
      <span class="exec-metric-value">{{ analytics.overall_sentiment.blocks_analyzed|default(0) }}</span>
    </div>
    <div class="exec-metric">
      <span class="exec-metric-label">Active Parishes</span>
      <span class="exec-metric-value">{{ analytics.parishes|selectattr('mentions', 'gt', 0)|list|length }}</span>
    </div>
    <div class="exec-metric">
      <span class="exec-metric-label">Critical Issues</span>
      <span class="exec-metric-value {% if analytics.emerging_issues|selectattr('urgency', 'ge', 0.7)|list|length > 0 %}exec-metric-value--negative{% endif %}">
        {{ analytics.emerging_issues|selectattr('urgency', 'ge', 0.7)|list|length }}
      </span>
    </div>
    <div class="exec-metric">
      <span class="exec-metric-label">Status</span>
      <span class="exec-metric-value" style="color: var(--exec-accent);">{{ analytics.overall_sentiment.label|default('No Data') }}</span>
    </div>
  </div>

  <!-- Critical Alert Banner (only if high urgency issues) -->
  {% set critical_issues = analytics.emerging_issues|selectattr('urgency', 'ge', 0.7)|list %}
  {% if critical_issues %}
  <div class="exec-alert">
    <i class="bi bi-exclamation-triangle-fill exec-alert-icon"></i>
    <span class="exec-alert-text">
      <strong>{{ critical_issues|length }} HIGH PRIORITY</strong> issue{{ 's' if critical_issues|length > 1 else '' }} requiring attention:
      {% for issue in critical_issues[:3] %}{{ issue.topic }}{% if not loop.last %}, {% endif %}{% endfor %}
    </span>
  </div>
  {% endif %}

  <!-- Main Grid -->
  <div class="exec-grid">
    <!-- Row 1: Topic Activity + Parish Table -->
    <div class="exec-panel">
      <div class="exec-panel-header">Policy Category Activity</div>
      <div class="exec-panel-body" style="padding: 0.5rem;">
        <div id="policyTopicsChart" style="height: 350px;"></div>
      </div>
    </div>

    <div class="exec-panel">
      <div class="exec-panel-header">Parish Sentiment by Mentions</div>
      <div class="exec-panel-body">
        <div id="parishTableContainer"></div>
      </div>
    </div>

    <!-- Row 2: Topic Sentiment + Sentiment Distribution -->
    <div class="exec-panel">
      <div class="exec-panel-header">Topic Sentiment Analysis</div>
      <div class="exec-panel-body" style="padding: 0.5rem;">
        <div id="topicSentimentChart" style="height: 400px;"></div>
      </div>
    </div>

    <div class="exec-panel">
      <div class="exec-panel-header">Sentiment Distribution</div>
      <div class="exec-panel-body">
        <div id="sentimentDistChart"></div>
      </div>
    </div>
  </div>

  <!-- Methodology Footer -->
  <div class="exec-methodology">
    <div class="exec-methodology-title">
      <i class="bi bi-info-circle"></i> Methodology
    </div>
    <dl class="exec-methodology-content">
      <dt>Sentiment Analysis</dt>
      <dd>AI-powered NLP analyzing caller discourse tone, word choice, and contextual sentiment.</dd>
      <dt>Urgency Scoring</dt>
      <dd>Composite metric: mention frequency delta (7-day), emotional intensity, call volume spikes, cross-block persistence.</dd>
      <dt>Data Source</dt>
      <dd>Down to Brass Tacks (VOB 92.9 FM) • Automated transcription & analysis • Updated daily</dd>
    </dl>
  </div>

  <!-- Chart Loading and API Integration -->
  <script>
    // =========================================================================
    // DATE CONFIGURATION
    // =========================================================================
    const VIEW_DATE = '{{ view_date.strftime("%Y-%m-%d") if view_date else "" }}';
    const ANALYTICS_DAYS = 7;

    // Build query string with date support
    function buildAnalyticsQuery(days = ANALYTICS_DAYS) {
      let query = `days=${days}`;
      if (VIEW_DATE) {
        query += `&end_date=${VIEW_DATE}`;
      }
      return query;
    }

    // =========================================================================
    // CHART LOADER FUNCTIONS (Executive Style)
    // =========================================================================

    /**
     * Load Policy Topics Chart (Horizontal Bars)
     */
    async function loadPolicyTopicsChart() {
      try {
        const response = await fetch(`/api/analytics/topics/trending?${buildAnalyticsQuery()}`);

        if (!response.ok) {
          throw new Error(`API error: ${response.status}`);
        }

        const data = await response.json();

        // Transform API data to chart format
        const chartData = data.topics.map(topic => ({
          category: topic.name || topic.category || 'Uncategorized',
          count: topic.blocks || topic.total_weight || 0,
          sentiment: topic.avg_sentiment || 0
        }));

        // Sort by count descending, take top 8
        chartData.sort((a, b) => b.count - a.count);
        const top8 = chartData.slice(0, 8);

        if (top8.length === 0) {
          document.getElementById('policyTopicsChart').innerHTML =
            '<div style="text-align: center; padding: 2rem; color: var(--exec-text-muted);">No topic data available</div>';
          return;
        }

        if (typeof EchobotCharts !== 'undefined' && EchobotCharts.createPolicyTopicsChart) {
          EchobotCharts.createPolicyTopicsChart('policyTopicsChart', top8);
        }
      } catch (error) {
        console.error('Failed to load policy topics chart:', error);
        document.getElementById('policyTopicsChart').innerHTML =
          '<div style="text-align: center; padding: 2rem; color: var(--exec-text-muted);">Failed to load data</div>';
      }
    }

    /**
     * Load Sentiment Distribution Bar (replaces donut)
     */
    async function loadSentimentDistChart() {
      try {
        const response = await fetch(`/api/analytics/sentiment?date=${VIEW_DATE || new Date().toISOString().split('T')[0]}`);

        if (!response.ok) {
          throw new Error(`API error: ${response.status}`);
        }

        const data = await response.json();
        const dist = data.sentiment_distribution || {};

        // Use executive color scheme
        const chartData = [
          { label: 'Strongly Positive', value: dist['Strongly Positive'] || 0 },
          { label: 'Somewhat Positive', value: dist['Somewhat Positive'] || 0 },
          { label: 'Mixed/Neutral', value: dist['Mixed/Neutral'] || 0 },
          { label: 'Somewhat Negative', value: dist['Somewhat Negative'] || 0 },
          { label: 'Strongly Negative', value: dist['Strongly Negative'] || 0 }
        ];

        if (typeof EchobotCharts !== 'undefined' && EchobotCharts.createSentimentDistributionBar) {
          EchobotCharts.createSentimentDistributionBar('sentimentDistChart', chartData);
        }
      } catch (error) {
        console.error('Failed to load sentiment distribution:', error);
        document.getElementById('sentimentDistChart').innerHTML =
          '<div style="text-align: center; padding: 2rem; color: var(--exec-text-muted);">Failed to load data</div>';
      }
    }

    /**
     * Load Topic Sentiment Chart (Diverging Bars)
     */
    async function loadTopicSentimentChart() {
      try {
        const response = await fetch(`/api/analytics/topics/trending?${buildAnalyticsQuery()}`);

        if (!response.ok) {
          throw new Error(`API error: ${response.status}`);
        }

        const data = await response.json();

        const chartData = data.topics.map(topic => ({
          topic: topic.name || 'Unknown Topic',
          avgSentiment: topic.avg_sentiment || 0,
          count: topic.blocks || topic.total_weight || 0
        }));

        // Sort by absolute sentiment (most polarizing first)
        chartData.sort((a, b) => Math.abs(b.avgSentiment) - Math.abs(a.avgSentiment));
        const top10 = chartData.slice(0, 10);

        if (top10.length === 0) {
          document.getElementById('topicSentimentChart').innerHTML =
            '<div style="text-align: center; padding: 2rem; color: var(--exec-text-muted);">No topic sentiment data</div>';
          return;
        }

        if (typeof EchobotCharts !== 'undefined' && EchobotCharts.createTopicSentimentChart) {
          EchobotCharts.createTopicSentimentChart('topicSentimentChart', top10);
        }
      } catch (error) {
        console.error('Failed to load topic sentiment chart:', error);
        document.getElementById('topicSentimentChart').innerHTML =
          '<div style="text-align: center; padding: 2rem; color: var(--exec-text-muted);">Failed to load data</div>';
      }
    }

    /**
     * Load Parish Table (replaces radial chart)
     */
    async function loadParishTable() {
      try {
        const response = await fetch(`/api/analytics/parishes?${buildAnalyticsQuery()}`);

        if (!response.ok) {
          throw new Error(`API error: ${response.status}`);
        }

        const data = await response.json();

        const chartData = data.parishes.map(p => ({
          parish: p.parish || 'Unknown',
          sentiment: p.avg_sentiment || 0,
          count: p.mention_count || 0
        }));

        if (typeof EchobotCharts !== 'undefined' && EchobotCharts.createParishTable) {
          EchobotCharts.createParishTable('parishTableContainer', chartData);
        }
      } catch (error) {
        console.error('Failed to load parish table:', error);
        document.getElementById('parishTableContainer').innerHTML =
          '<div style="text-align: center; padding: 2rem; color: var(--exec-text-muted);">Failed to load data</div>';
      }
    }

    // =========================================================================
    // INITIALIZE ALL CHARTS ON PAGE LOAD
    // =========================================================================

    document.addEventListener('DOMContentLoaded', function() {
      console.log('Initializing executive analytics dashboard...');

      // Load all charts in parallel
      Promise.all([
        loadPolicyTopicsChart(),
        loadSentimentDistChart(),
        loadTopicSentimentChart(),
        loadParishTable()
      ]).then(() => {
        console.log('Executive dashboard loaded successfully');
      }).catch(error => {
        console.error('Error loading charts:', error);
      });
    });
  </script>

  <!-- Plotly.js for chart rendering -->
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <!-- Echobot Charts library -->
  <script src="/static/js/charts.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
